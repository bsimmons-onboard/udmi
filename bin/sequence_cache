#!/bin/bash -e
#
# Command line wrapper to create a config file, and pass off
# to sequence looper for complete sequence run.
#

ROOT_DIR=$(realpath $(dirname $0)/..)
TEST_LOG=/tmp/test_log.txt
log_level=INFO
alt_registry=ZZ-REDIRECT-NA
min_stage=BETA

TEST_LIST=/tmp/sequencer_tests.txt
find validator/sequences/ -name sequencer.log | xargs fgrep -H RESULT | awk '{print $7}' > $TEST_LIST
find sites/udmi_site_model/out/devices/ -name sequencer.log | xargs fgrep -H RESULT | awk '{print $7}'>> $TEST_LIST
cat $TEST_LIST | sort | uniq > $TEST_LIST.sorted
all_tests=$(cat $TEST_LIST.sorted)
for test in $all_tests; do
    src_dir=sites/udmi_site_model/out/devices/AHU-1/tests/$test
    cache_dir=validator/sequences/$test/
    if [[ ! -f $src_dir/sequence.md ]]; then
        echo Skipping $src_dir
    elif diff -q $src_dir/sequence.md $cache_dir/sequence.md; then
        echo "Keeping " $cache_dir
    else
        echo Updating $cache_dir from $src_dir...
        rm -rf $cache_dir
        cp -a $src_dir $(dirname $cache_dir)
        ls -l $src_dir/sequence.md $cache_dir/sequence.md
    fi
done

